<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Online Art Store</title>
    <meta name="csrf-token" id="csrf-token" th:content="${_csrf.token}"/>
    <meta name="csrf-header" id="csrf-header" th:content="${_csrf.headerName}"/>
    <meta name="auctionId" id="auctionId" th:content="${auctionId}"/>
    <meta name="userId" id="userId" th:content="${userId}"/>
    <style>
        table {
            border-collapse: collapse;
        }

        table, td, th {
            border: 1px solid black;
        }

        td, th {
            margin: 8px;
        }

        #current_date_time_block {
            color: deeppink;
            font-size: 14pt;
            border: 2px solid purple;
            background: plum;
            padding: 5px 20px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
<nav>
    <menu>
        <li><a th:href="@{/}">General page</a></li>
        <li sec:authorize="isAuthenticated()">
            <a th:href="@{/privatePage}">Private page</a></li>
        <li sec:authorize="hasRole('USER')">
            <a th:href="@{/userPage}">User page</a></li>
        <li sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/mainAdminPage}">Admin page</a></li>
        <li sec:authorize="isAnonymous()">
            <a th:href="@{/singup}">Sing Up</a></li>
        <li sec:authorize="isAnonymous()">
            <a th:href="@{/login}">Login</a></li>
        <li sec:authorize="isAuthenticated()">
            Welcome <span sec:authentication="name"></span>!
        </li>
        <li sec:authorize="isAuthenticated()">
            <a th:href="@{/logout}">Logout</a></li>
    </menu>
</nav>
<h1 style="color: blue">Participate in the auction!</h1>
<h2>Welcome <span sec:authentication="name"></span>!</h2>
<table>
    <thead>
    <tr>
        <th>Title Auction:</th>
        <th>Start Date:</th>
        <th>End Date:</th>
        <th>Starting Price:</th>
        <th>Current Bet:</th>
        <th>Active:</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="auction:${auctions}">
        <td th:text="${auction.titleAuction}"></td>
        <td th:text="${auction.startDate}"></td>
        <td th:text="${auction.endDate}"></td>
        <td th:text="${auction.startingPrice}"></td>
        <td th:text="${auction.currentBet}"></td>
        <td th:text="${auction.active}"></td>
    </tbody>
</table>
<h2>Place Your bet:</h2>
<div>
    <div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </div>
    <div>
        <label for="createdDate">Created date:</label>
        <input type="hidden" id="createdDate" name="createdDate"/>
    </div>
    <div>
        <label for="amountMoney">Amount money:</label>
        <input type="number" id="amountMoney" name="amountMoney" min="1000" step="500" required="required"/>
    </div>
    <div>
        <label for="active">Active:</label>
        <input type="checkbox" id="active" name="active"/>
    </div>
    <div>
        <label for="auctions">Auction</label>
        <select name="auctions" id="auctions"></select>
    </div>
    <div>
        <label for="users">User</label>
        <select name="users" id="users"></select>
    </div>
    <div>
        <input type="submit" id="saveBet"/>
    </div>
</div>

<h2>BETS table:</h2>
<table>
    <thead>
    <tr>
        <th>Id</th>
        <th>Created Date</th>
        <th>Amount Money</th>
        <th>Active</th>
        <th>Auction</th>
        <th>User</th>
        <th>Option</th>
    </tr>
    </thead>
    <tbody id="Bets-table">
    </tbody>
</table>
<div id="current_date_time_block"></div>
<script>
    const createdDate = document.getElementById('current_date_time_block');
    const auctionIdMeta = document.getElementById("auctionId");
    const userIdMeta = document.getElementById("userId");
    const auctionId = auctionIdMeta.content;
    const userId = userIdMeta.content;
    const betsTable = document.getElementById('Bets-table');
    const saveBetButton = document.getElementById('saveBet');
    const baseURI = 'http://localhost:8080/participateAuction/api/v2';
    const other1URI = `http://localhost:8080/participateAuction/${auctionId}`;
    const other2URL = `http://localhost:8080/participateAuction/${userId}`;


    /* функция добавления ведущих нулей */
    /* (если число меньше десяти, перед числом добавляем ноль) */
    function zero_first_format(value) {
        if (value < 10) {
            value = '0' + value;
        }
        return value;
    }

    /* функция получения текущей даты и времени */
    function date_time() {
        let current_datetime = new Date();
        let day = zero_first_format(current_datetime.getDate());
        let month = zero_first_format(current_datetime.getMonth() + 1);
        let year = current_datetime.getFullYear();
        let hours = zero_first_format(current_datetime.getHours());
        let minutes = zero_first_format(current_datetime.getMinutes());
        let seconds = zero_first_format(current_datetime.getSeconds());
        return day + "." + month + "." + year + " " + hours + ":" + minutes + ":" + seconds;
    }

    /* каждую секунду получаем текущую дату и время */
    /* и вставляем значение в блок с id "current_date_time_block2" */
    setInterval(function () {
        createdDate.innerHTML = date_time();
    }, 1000);


    function addBet(bet) {
        const tr = document.createElement('tr');
        const tdDelete = document.createElement('td');
        tdDelete.innerHTML = '<button>DELETE</button>';
        const tdUpdate = document.createElement('td');
        tdUpdate.innerHTML = '<button>UPDATE</button>';
        for (const prop in bet) {
            const td = document.createElement('td');
            if (prop === 'auction') {
                td.append(document.createTextNode(bet[prop].titleAuction));
            }
            if (prop === 'user') {
                td.append(document.createTextNode(bet[prop].username));
            }
            if (prop !== 'auction' && prop !== 'user') {
                td.append(document.createTextNode(bet[prop]));
            }
            tr.append(td);
            tr.append(tdDelete);
            tr.append(tdUpdate);
        }
        betsTable.append(tr);
    }

    function fillTableBets(bets) {
        betsTable.innerHTML = '';
        bets.forEach(bet => {
            addBet(bet);
        });
    }

    async function loadBets() {
        const response = await fetch(`${baseURI}/bets`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        const bets = await response.json();
        console.log(bets);
        fillTableBets(bets);
    }

    window.addEventListener('load', loadBets);

    async function saveBet() {
        const createdDateInput = document.getElementById('createdDate');
        const amountMoneyInput = document.getElementById('amountMoney');
        const activeInput = document.getElementById('active');
        const auctionsSelect = document.getElementById('auctions');
        const usersSelect = document.getElementById('users');

        const bet = {
            createdDate: createdDateInput.value,
            amountMoney: amountMoneyInput.value,
            active: activeInput.checked,
            auctionId: auctionsSelect.value,
            userId: usersSelect.value
        };
        const csrfToken = document.getElementById('_csrf').content;
        console.log("Token = " + csrfToken);
        const csrfHeader = document.getElementById('_csrf_header').content;
        const response = await fetch(`${baseURI}/bets`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify(bet)
        });
        console.log("**********" + response.status);
        if (response.status === 201) {
            const loc = response.headers.get('location');
            const resp = await fetch(`http://localhost:8080${loc}`)
            addBet(await resp.json())
        } else {
            alert('Error: ' + response.status);
        }
    }

    saveBetButton.addEventListener('click', saveBet);

</script>
</body>
</html>